const express = require('express');
const router = express.Router();
const pool = require('../db'); // usa el pool que ya tenés configurado

/**
 * GET /api/sesiones/:user_id
 * Devuelve todas las sesiones de un usuario
 */
router.get('/:user_id', async (req, res) => {
  const { user_id } = req.params;

  try {
    const result = await pool.query(
      `SELECT *
       FROM sesiones
       WHERE user_id = $1
       ORDER BY fecha DESC, id DESC`,
      [user_id]
    );

    res.json({ ok: true, sesiones: result.rows });
  } catch (error) {
    console.error('Error obteniendo sesiones:', error);
    res.status(500).json({ ok: false, error: 'Error obteniendo sesiones' });
  }
});

/**
 * POST /api/sesiones
 * Crea una nueva sesión
 */
router.post('/', async (req, res) => {
  const {
    user_id,
    fecha,
    plataforma,
    tipo,
    buy_in,
    cash_out,
    duracion,
    modalidad,
    created_at
  } = req.body;

  try {
    const result = await pool.query(
      `INSERT INTO sesiones
      (user_id, fecha, plataforma, tipo, buy_in, cash_out, duracion, modalidad, created_at)
      VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9)
      RETURNING *`,
      [
        user_id,
        fecha,
        plataforma,
        tipo,
        buy_in,
        cash_out ?? null,
        duracion ?? null,
        modalidad ?? null,
        created_at ?? new Date()
      ]
    );

    res.json({ ok: true, sesion: result.rows[0] });
  } catch (error) {
    console.error('Error creando sesión:', error);
    res.status(500).json({ ok: false, error: 'Error creando sesión' });
  }
});

module.exports = router;
